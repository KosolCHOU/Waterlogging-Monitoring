{% extends "base.html" %}
{% block title %}Dashboard – CropXcel{% endblock %}

{% block head %}
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
  <style>
    html, body { height:100%; overflow:hidden; margin:0; background:#f1f5f9;
      font-family: system-ui, -apple-system, "Segoe UI", Roboto, Arial, sans-serif; }

    /* ===== LAYOUT ===== */
    .brand{padding:6px 10px 0 10px}
    .brand span{font-weight:900;font-size:20px;background:#fff;border-radius:8px;padding:4px 8px;box-shadow:0 2px 8px rgba(0,0,0,.06)}
    .dash{ display:grid; grid-template-columns: 1.35fr 1fr; gap:12px; padding:10px;
           height: calc(100vh - 20px); box-sizing:border-box; }
    .mapCard{ position:relative; background:#fff; border-radius:14px;
              box-shadow:0 8px 24px rgba(0,0,0,.12); overflow:hidden; height:100%; }
    .exit-maponly{ position:absolute; right:12px; top:12px; z-index:1000; display:none; }
    .mapCard .leaflet-container{ height:100% !important; width:100% !important; }

    .colR{ display:flex; flex-direction:column; gap:12px; height:100%; min-height:0; overflow:auto; }
    .card{ background:#fff; border-radius:14px; box-shadow:0 8px 24px rgba(0,0,0,.12);
           padding:12px; overflow:hidden; flex:0 0 auto; }
    .card-head{ display:flex; align-items:center; justify-content:space-between; gap:12px; margin-bottom:8px; }
    .pretty{ margin:0; font-size:16px; font-weight:800; letter-spacing:.2px; color:#0f172a; position:relative; padding-left:18px; }
    .pretty::before{ content:""; width:10px; height:10px; border-radius:50%; position:absolute; left:0; top:4px;
                     background: radial-gradient(circle at 30% 30%, #34d399, #0ea5e9); box-shadow: 0 0 0 2px #fff; }
    .head-actions{ display:flex; gap:10px; flex-wrap:wrap; }
    .btn{ background:#e2e8f0; color:#0f172a; border:0; cursor:pointer; padding:8px 14px; border-radius:999px; font-weight:600; }
    .btn.btn-brand{ background:#0ea5e9; color:#fff; }

    /* Map-only mode */
    body.map-only .colR{ display:none; }
    body.map-only .dash{ grid-template-columns:1fr; }
    body.map-only .mapCard{ height:100%; }
    body.map-only .exit-maponly{ display:block; }

    @media (max-width: 1024px){ .dash{ grid-template-columns: 1fr; } }

    /* ===== TABLES ===== */
    .minitable{ width:100%; border-collapse:separate; border-spacing:0; font-size:12px; border-radius:12px; overflow:hidden; }
    .minitable th, .minitable td{
      padding:6px 8px; border-bottom:1px solid #e5e7eb; color:#0f172a; vertical-align:middle;
      text-overflow:ellipsis; overflow:hidden; white-space:nowrap; font-weight:500;
    }
    .minitable thead th{ position:sticky; top:0; background:linear-gradient(#fff,#f8fafc); font-weight:800; z-index:1;
                         box-shadow: inset 0 -1px 0 #e5e7eb, 0 1px 0 rgba(0,0,0,.02); }
    .minitable tbody tr:nth-child(even){ background:#fafafa; }
    .minitable tbody tr:hover{ background:#eef6ff; box-shadow:inset 0 0 0 9999px rgba(14,165,233,.06); }

    .minitable.farmer{ table-layout:fixed; }
    .minitable.farmer th, .minitable.farmer td{ height:32px; text-align:center; }

    .minitable.tech{ table-layout:auto; min-width:980px; font-variant-numeric:tabular-nums; }
    .minitable.tech th, .minitable.tech td{ height:30px; white-space:nowrap; text-align:center; }
    .minitable.tech td:first-child, .minitable.tech th:first-child{ text-align:left; position:sticky; left:0; z-index:2; background:inherit; box-shadow:1px 0 0 #e5e7eb; }
    .minitable.tech td.spark{ background: linear-gradient(90deg, rgba(14,165,233,.25) calc(var(--pct,0)*1%), transparent 0); border-radius:6px; }

    .tech-wrap{ overflow:auto; scrollbar-gutter:stable both-edges; }
    .tech-wrap::-webkit-scrollbar{ height:10px; width:10px; }
    .tech-wrap::-webkit-scrollbar-thumb{ background:#cbd5e1; border-radius:999px; }
    .tech-wrap::-webkit-scrollbar-track{ background:#f1f5f9; }

    th.sortable{ cursor:pointer; user-select:none; }
    th.sortable::after{ content:"▾"; margin-left:6px; opacity:.35; font-size:12px; }
    th.sortable.asc::after{ content:"▴"; }

    /* ===== ANALYSIS SCALE ===== */
    .scaleRow { display:grid; grid-template-columns: 160px 1fr; gap:14px; align-items:center; padding: 4px 2px; }
    .donutWrap{ display:flex; align-items:center; justify-content:center; }
    .legend { display:grid; grid-template-columns:1fr; gap:8px; }
    .legrow{
      display:grid;
      grid-template-columns:auto 1fr auto 1fr auto; /* bubble | name | ha | bar | % */
      align-items:center; gap:10px; padding:6px 8px;
      border-radius:10px; background:#f8fafc;
    }
    .legrow:hover { background:#f1f5f9; }
    .bubble{ width:12px; height:12px; border-radius:50%; background:var(--c);
      box-shadow: inset 0 0 0 2px rgba(255,255,255,.9), 0 0 0 1px rgba(0,0,0,.08); }
    .lg-name{ color:#0f172a; font-weight:600; white-space:nowrap; }
    .lg-pill{ font-size:11px; color:#0f172a; background:#e5e7eb; padding:2px 6px; border-radius:999px; white-space:nowrap; }
    .lg-bar{ height:8px; background:#e5e7eb; border-radius:999px; position:relative; overflow:hidden; }
    .lg-bar .fill{ position:absolute; inset:0 auto 0 0; width:calc(var(--pct)*1%); background:var(--c); border-radius:999px; transition:width .6s ease; }
    .lg-val{ font-variant-numeric:tabular-nums; color:#0f172a; text-align:right; min-width:48px; }

    .total-chip{ font-size:16px; color:#0f172a; background:#e5e7eb; padding:2px 8px; border-radius:999px; }

    /* Donut */
    .scaleRow svg circle { vector-effect: non-scaling-stroke; }
    .scale-donut .segments .seg{ transition: stroke-dasharray .45s ease, stroke .2s ease; stroke-linecap:round; }
    .scale-donut .seg-0{ stroke:#2ecc71; } /* Healthy */
    .scale-donut .seg-1{ stroke:#f1c40f; } /* Watch   */
    .scale-donut .seg-2{ stroke:#e67e22; } /* Concern */
    .scale-donut .seg-3{ stroke:#e74c3c; } /* Alert   */

    /* Hover pill (for simple server probe) */
    #hoverpill{position:absolute;top:10px;left:10px;z-index:1000;display:none;
      background:#0f172a;color:#fff;padding:6px 10px;border-radius:999px;font-size:12px;opacity:.92}
    #toggleInsights {
      display: block;          /* makes it respect width */
      width: 100%;             /* full width of its container */
      text-align: center;      /* center the text */
      margin-top: 8px;         /* keep your spacing */
    }
  </style>
{% endblock %}

{% block content %}

<div class="dash">
  <!-- LEFT: MAP -->
  <div class="mapCard">
    <div id="map" style="height:100%; width:100%"></div>
    <button class="btn btn-brand exit-maponly" id="exitMapOnlyBtn" title="Exit Map Only">Exit Map Only</button>
  </div>

  <!-- RIGHT: Insights, Scale, Plot -->
  <div class="colR">
    <div class="card">
      <div class="card-head">
        <h3 id="insTitle" class="pretty">Per-pass Insights</h3>
        <div class="head-actions">
          <button class="btn btn-brand" id="techBtn">Show Technical Details</button>
          <button class="btn btn-brand" id="mapOnlyBtn">Map Only</button>
        </div>
      </div>

      <div class="tech-wrap">
        <div id="insightsTable" data-max="5" data-tech-max="5">
          <!-- filled by fetch -->
        </div>
      </div>

      <button class="btn" id="toggleInsights" style="margin-top:8px;">Show more</button>
    </div>

    <div class="card">
      <div class="card-head">
        <div class="pretty">Analysis Scale</div>
      </div>
      <div class="scaleRow">
        <!-- Donut -->
        <div class="donutWrap">
          <svg class="scale-donut" width="140" height="140" viewBox="0 0 140 140" aria-label="Analysis Scale">
            <g class="segments" transform="rotate(-90 70 70)" data-sw="10">
              <circle class="seg seg-0" cx="70" cy="70" r="58" fill="none" stroke-width="10" pathLength="100"/>
              <circle class="seg seg-1" cx="70" cy="70" r="46" fill="none" stroke-width="10" pathLength="100"/>
              <circle class="seg seg-2" cx="70" cy="70" r="34" fill="none" stroke-width="10" pathLength="100"/>
              <circle class="seg seg-3" cx="70" cy="70" r="22" fill="none" stroke-width="10" pathLength="100"/>
            </g>
            <text id="donutCenter" x="70" y="72" text-anchor="middle" font-size="12" font-weight="600" fill="#0f172a">0 Ha</text>
          </svg>
        </div>
        <!-- Legend -->
        <div class="legend">
          <div id="legendRows"><!-- injected rows --></div>
        </div>
      </div>
    </div>

    <div class="card">
      <h3 class="pretty">Plot</h3>
      <div id="plotSection"><!-- injected --></div>
    </div>
  </div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
  // --- context from Django ---
  const JOB_ID     = {{ job_id|safe }};
  const BOUNDS     = {{ bounds|safe }};               // [[S,W],[N,E]]
  const OVERLAY_URL= "{{ overlay_png|default:'' }}";
  const HOTSPOTS   = "{{ hotspots_url|default:'' }}";
  const PROBE_BIN  = "{{ probe_bin|default:'' }}";
  const PROBE_META = "{{ probe_meta|default:'' }}";
  const FIELD_ID   = {{ field.id }};

  /* ================= MAP ================= */
  const map = L.map('map');
  L.tileLayer(
    'https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}',
    { attribution: 'Tiles © Esri' }
  ).addTo(map);
  map.fitBounds(BOUNDS);

  map.createPane('overlayPane');
  map.getPane('overlayPane').style.zIndex = 450;

  if (OVERLAY_URL && OVERLAY_URL.endsWith('.png')) {
    L.imageOverlay(OVERLAY_URL, BOUNDS, { opacity:0.75, pane:'overlayPane' }).addTo(map);
  }

  // Hotspots (points/centroids)
  function levelToColor(level){
    if (level === "High") return "#e31a1c";
    if (level === "Caution") return "#f59e0b";
    return "#1f78b4";
  }
  function pct(x){ return Math.max(0, Math.min(100, Math.round(x*100))); }

  if (HOTSPOTS) {
    fetch(HOTSPOTS, { cache: 'no-store' })
      .then(r => r.json())
      .then(gj => {
        L.geoJSON(gj, {
          pointToLayer: function(f, latlng){
            const hasRisk = typeof f.properties?.risk === "number" && isFinite(f.properties.risk);
            const rpct = Number(f.properties?.risk_pct);
            const risk = hasRisk ? Number(f.properties.risk)
                                : (isFinite(rpct) ? Math.max(0, Math.min(100, rpct)) / 100 : 0);
            const level = f.properties?.level || (risk>=0.7 ? "High" : risk>=0.4 ? "Caution" : "Low");
            const color = levelToColor(level);

            const m = L.circleMarker(latlng, { radius:6, color:"#111", weight:1, opacity:0.9, fillColor:color, fillOpacity:0.9 });
            m.bindTooltip(`Risk: ${pct(risk)}% · ${level}`, {direction:"top", offset:[0,-6]});

            const reason = f.properties?.reason || "Potential waterlogging area";
            const action = f.properties?.action || "";
            const chart  = f.properties?.chart_b64 ? `<img src="data:image/png;base64,${f.properties.chart_b64}" style="width:100%;border-radius:8px;margin-top:8px">` : "";

            const html = `
              <div style="min-width:240px">
                <div style="display:flex;align-items:center;gap:8px">
                  <div style="width:10px;height:10px;border-radius:50%;background:${color}"></div>
                  <b>Hotspot</b>
                </div>
                <div style="width:100%;height:6px;background:#e5e7eb;border-radius:999px;overflow:hidden;margin-top:6px">
                  <span style="display:block;height:100%;width:${pct(risk)}%;background:${color}"></span>
                </div>
                <div style="margin-top:8px;font-size:12px;color:#334155">
                  <div><b>Risk:</b> ${pct(risk)}% · ${level}</div>
                  ${f.properties?.area_ha ? `<div><b>Area:</b> ${Number(f.properties.area_ha).toFixed(4)} ha</div>` : ``}
                  <div><b>Reason:</b> ${reason}</div>
                  ${action ? `<div style="margin-top:4px"><b>Action:</b> ${action}</div>` : ``}
                </div>
                ${chart}
              </div>`;
            m.bindPopup(html);
            return m;
          }
        }).addTo(map);
      })
      .catch(()=>{});
  }

  // Hover probe (simple server endpoint)
  const pill = document.getElementById("hoverpill");
  function showPill(text){ pill.style.display='block'; pill.textContent = text; }
  function hidePill(){ pill.style.display='none'; }
  let probeTimer = null;
  map.on("mousemove", (e) => {
    if (probeTimer) return;
    probeTimer = setTimeout(() => { probeTimer = null; }, 180);
    fetch(`/probe/${JOB_ID}?lat=${e.latlng.lat}&lon=${e.latlng.lng}`)
      .then(r => r.ok ? r.json() : Promise.reject())
      .then(d => {
        if (d && typeof d.value === "number") {
          const p = Math.round(d.value * 100);
          const lvl = d.level || (d.value>=0.7 ? "High" : d.value>=0.4 ? "Caution" : "Low");
          showPill(`risk: ${p}% · ${lvl}`);
        } else hidePill();
      })
      .catch(()=>hidePill());
  });

  /* ================= INSIGHTS + SCALE ================= */
  const tableWrap = document.getElementById('insightsTable');
  const title     = document.getElementById('insTitle');
  const moreBtn   = document.getElementById('toggleInsights');
  const techBtn   = document.getElementById('techBtn');
  const mapBtn    = document.getElementById('mapOnlyBtn');
  const exitBtn   = document.getElementById('exitMapOnlyBtn');
  const legendDiv = document.getElementById('legendRows');
  const donutCtr  = document.getElementById('donutCenter');

  let farmerHTML = "", techHTML = "", scaleHTML = "", plotHTML = "";
  let techMode = false, expandedFarmer=false, expandedTech=false;

  function applyRowLimit(t, max){
    if (!t || !t.tBodies[0]) return;
    const rows = Array.from(t.tBodies[0].rows);
    rows.forEach((r,i)=>{ r.style.display = (i < max) ? '' : 'none'; });
  }
  function makeSortableAndSparky(t, isTech){
    if (!t) return;
    const ths = t.querySelectorAll('thead th');
    ths.forEach((th, idx)=>{
      th.classList.add('sortable');
      th.onclick = () => sortByColumn(t, idx, th);
    });
    if (!isTech) return;
    const rows = Array.from(t.tBodies[0]?.rows || []);
    const cols = ths.length;
    const isNumeric = Array(cols).fill(false);
    for (let c=1; c<cols; c++){
      const sample = rows.slice(0, Math.min(12, rows.length))
        .map(r => parseFloat((r.cells[c]?.innerText || '').replace(/[, ]/g,'')));
      const valid = sample.filter(v => Number.isFinite(v)).length;
      isNumeric[c] = valid >= Math.ceil(sample.length*0.6);
    }
    const min = Array(cols).fill(+Infinity), max = Array(cols).fill(-Infinity);
    rows.forEach(r=>{
      for (let c=1; c<cols; c++){
        if (!isNumeric[c]) continue;
        const v = parseFloat((r.cells[c].innerText||'').replace(/[, ]/g,''));
        if (Number.isFinite(v)){ if (v<min[c]) min[c]=v; if (v>max[c]) max[c]=v; }
      }
    });
    rows.forEach(r=>{
      for (let c=1; c<cols; c++){
        if (!isNumeric[c]) continue;
        const cell = r.cells[c];
        const v = parseFloat((cell.innerText||'').replace(/[, ]/g,''));
        let p = 0;
        if (Number.isFinite(v) && max[c] > min[c]) p = (v-min[c])/(max[c]-min[c])*100;
        cell.classList.add('spark');
        cell.style.setProperty('--pct', p.toFixed(2));
      }
    });
  }
  function sortByColumn(table, colIdx, thEl, dir){
    const tbody = table.tBodies[0];
    const rows  = Array.from(tbody.rows);
    const asc = (dir === 'asc') ? true : (dir === 'desc') ? false : !thEl.classList.contains('asc');
    const parseVal = (s)=>{
      const txt = (s||'').trim();
      if (/^\d{4}-\d{2}-\d{2}$/.test(txt)) return new Date(txt).getTime();
      const n = parseFloat(txt.replace(/[, ]/g,''));
      return Number.isFinite(n) ? n : txt;
    };
    rows.sort((a,b)=>{
      const A = parseVal(a.cells[colIdx]?.innerText);
      const B = parseVal(b.cells[colIdx]?.innerText);
      if (typeof A === 'number' && typeof B === 'number') return asc ? (A-B) : (B-A);
      return asc ? String(A).localeCompare(String(B)) : String(A).localeCompare(String(B)) * -1;
    });
    table.querySelectorAll('th').forEach(th=>th.classList.remove('asc'));
    if (asc) thEl.classList.add('asc');
    rows.forEach(r=>tbody.appendChild(r));
  }

  function buildDonutMatchBars(){
    const svg  = document.querySelector('.scale-donut');
    const segs = svg ? svg.querySelectorAll('.segments .seg') : null;
    const rows = Array.from(document.querySelectorAll('.legend .legrow'));
    if (!svg || !segs || !rows.length) return;

    // total ha to center
    const totalHa = rows.reduce((s, r) => s + (parseFloat(r.dataset.ha) || 0), 0);
    if (donutCtr) donutCtr.textContent = totalHa ? `${totalHa.toFixed(2)} Ha` : '0 Ha';

    segs.forEach((seg, i) => {
      const row = rows[i]; if (!row) return;
      const pct = Math.max(0, Math.min(100, parseFloat(row.dataset.pct)||0));
      const color = row.style.getPropertyValue('--c') || getComputedStyle(row).getPropertyValue('--c') || '#9ca3af';
      seg.setAttribute('stroke', color.trim());
      seg.setAttribute('stroke-dasharray', `${pct} ${100 - pct}`);
      seg.setAttribute('stroke-dashoffset', '0');
    });
  }
  function ensureFarmerColgroup(t) {
    if (!t || t.classList.contains('has-colgroup')) return;
    if (!t.querySelector('colgroup')) {
      const cg = document.createElement('colgroup');
      //             Date   Value  Risk   Area   Action
      ['75px','65px','55px','70px','auto'].forEach(w=>{
        const c = document.createElement('col');
        if (w !== 'auto') c.style.width = w;
        cg.appendChild(c);
      });
      t.insertBefore(cg, t.firstChild);
    }
    t.classList.add('has-colgroup');
  }
  function renderTables(){
    const maxF = Number(tableWrap?.dataset?.max ?? 5);
    const maxT = Number(tableWrap?.dataset?.techMax ?? 5);

    if (techMode) {
      title.textContent = 'Technical Details';
      tableWrap.innerHTML = techHTML || "<div class='empty'>No records.</div>";
      moreBtn.textContent = expandedTech ? 'Show less' : 'Show more';
      techBtn.textContent = 'Exit Technical Details';
      const t = tableWrap.querySelector('table');
      if (t){ t.classList.add('minitable','tech'); makeSortableAndSparky(t, true);
        const dateTH = t.querySelector('thead th:first-child'); if (dateTH) sortByColumn(t, 0, dateTH, 'desc');
        if (!expandedTech) applyRowLimit(t, maxT);
      }
    } else {
      title.textContent = 'Per-pass Insights';
      tableWrap.innerHTML = farmerHTML || "<div class='empty'>No records.</div>";
      moreBtn.textContent = expandedFarmer ? 'Show less' : 'Show more';
      techBtn.textContent = 'Show Technical Details';

      const t = tableWrap.querySelector('table');
      if (t){
        ensureFarmerColgroup(t);             // sets Date/Value/Risk/Area/Action widths
        t.classList.add('minitable','farmer');
        const dateTH = t.querySelector('thead th:first-child');
        if (dateTH) sortByColumn(t, 0, dateTH, 'desc');
        if (!expandedFarmer) applyRowLimit(t, maxF);
      }
    }
    buildDonutMatchBars();
  }

  function setMapOnly(on){
    document.body.classList.toggle('map-only', !!on);
    const isOn = document.body.classList.contains('map-only');
    mapBtn.textContent  = isOn ? 'Exit Map Only' : 'Map Only';
    exitBtn.style.display = isOn ? '' : 'none';
    setTimeout(()=> map.invalidateSize(true), 200);
  }

  moreBtn.onclick = ()=>{
    if (techMode) expandedTech = !expandedTech;
    else          expandedFarmer = !expandedFarmer;
    renderTables();
  };
  techBtn.onclick = ()=>{ techMode = !techMode; renderTables(); };
  mapBtn.onclick  = ()=> setMapOnly(!document.body.classList.contains('map-only'));
  exitBtn.onclick = ()=> setMapOnly(false);
  document.addEventListener('keydown', (e)=>{ if (e.key === 'Escape') setMapOnly(false); });

  // fetch insights (HTML chunks your view already produces)
  (async function(){
    try{
      const res = await fetch(`/fields/${FIELD_ID}/insights/`, {cache:'no-store'});
      const data = await res.json();
      farmerHTML = data.farmer_table_html || "";
      techHTML   = data.technical_table_html || "";
      scaleHTML  = data.legend_rows_html || "";
      plotHTML   = data.plot_section || "";
      document.getElementById("plotSection").innerHTML = plotHTML;
      document.getElementById("legendRows").innerHTML  = scaleHTML;
      renderTables();
    }catch(err){
      console.error("Insights load failed:", err);
      farmerHTML = ""; techHTML = ""; scaleHTML = ""; plotHTML = "";
      renderTables();
    }
  })();
</script>
{% endblock %}
