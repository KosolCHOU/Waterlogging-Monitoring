<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>CropXcel – Identify Your Cropland</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  {% load static %}
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
  <link rel="stylesheet" href="https://unpkg.com/leaflet-draw@1.0.4/dist/leaflet.draw.css">
  <link rel="stylesheet" href="{% static 'css/app.css' %}">
  <style>
    :root { --bg:#f1f7ee; --card:#ffffff; --pill:#eef7f3; --text:#111827; --muted:#6b7280; --accent:#10b981; }
    body { margin:0; background:var(--bg); font-family:system-ui, -apple-system, "Segoe UI", Roboto, Arial, sans-serif; color:var(--text); }
    .shell { max-width:1200px; margin:32px auto; padding:0 16px; }
    .crumbs { font-size:12px; color:var(--muted); margin-bottom:8px; }
    .title { font-size:28px; margin:0 0 4px 0; }
    .subtitle { color:var(--muted); margin:0 0 18px 0; }
    .grid { display:grid; grid-template-columns: 1.3fr 0.7fr; gap:18px; align-items:start; }
    .card { background:var(--card); border-radius:16px; box-shadow:0 10px 30px rgba(0,0,0,.06); }
    .map-card { padding:16px; position:relative; }
    .map-head { display:flex; justify-content:space-between; align-items:center; margin-bottom:10px; }
    .map-head .btn { background:var(--pill); border:none; padding:8px 12px; border-radius:10px; cursor:pointer; }
    #map { height:58vh; border-radius:12px; }
    .area-badge { position:absolute; left:16px; bottom:16px; background:#fff; border-radius:10px; padding:10px 12px; box-shadow:0 6px 18px rgba(0,0,0,.08); font-size:12px; }
    .area-badge .val { font-weight:700; font-size:14px; }

    .side { padding:16px; }
    .side h3 { margin:0 0 8px 0; font-size:18px; }
    .side .panel { background:#fff; border-radius:16px; padding:16px; box-shadow:0 10px 30px rgba(0,0,0,.06); }
    .field-row { display:flex; flex-direction:column; gap:6px; margin-bottom:12px; }
    .label { font-size:12px; color:var(--muted); }
    .input { width:100%; padding:10px 12px; border:1px solid #e5e7eb; border-radius:10px; background:#fafafa; }
    .save { width:100%; padding:12px; background:var(--accent); border:none; color:#fff; border-radius:12px; font-weight:600; cursor:pointer; }
    .muted { color:var(--muted); font-size:12px; }
    .footer-tip { margin-top:12px; background:#eef6ff; border-radius:12px; padding:12px; font-size:12px; color:#334155; }
    .link-btn { display:block; text-align:center; margin-top:10px; background:#3b82f6; color:#fff; text-decoration:none; padding:12px; border-radius:12px; font-weight:600; }
    .link-btn[disabled] { opacity:.6; pointer-events:none; }
  </style>
</head>
<body>
  <div class="shell">
    <div class="crumbs">Dashboard / Field Management / <span style="color:#10b981">Cropland Recognition</span></div>
    <h1 class="title">Identify Your Cropland</h1>
    <p class="subtitle">Use the map to draw your field. We’ll estimate its area in hectares and start the analysis.</p>

    <div class="grid">
      <!-- Map -->
      <div class="card map-card">
        <div class="map-head">
          <div style="font-weight:600;">Interactive Map</div>
          <div>
            <button id="layersBtn" class="btn" type="button">Layers</button>
            <button id="locBtn" class="btn" type="button">My Location</button>
          </div>
        </div>
        <div id="map"></div>
        <div class="area-badge">Selected Area<br><span id="areaVal" class="val">0.00 hectares</span></div>
      </div>

      <!-- Side panel -->
      <div class="side">
        <div class="panel">
          <h3>Field Information</h3>
          <div class="field-row">
            <div class="label">Estimated Area</div>
            <input id="areaInput" class="input" type="text" value="0.00 hectares" readonly>
          </div>
          <button id="saveBtn" class="save" type="button">Save Field</button>
          <div id="saveMsg" class="muted" style="margin-top:8px;"></div>

          <!-- Link to overlay result -->
          <a id="openOverlayBtn" href="#" class="link-btn" disabled>View Risk Map</a>

          <div class="footer-tip">
            <b>How to use</b><br>
            • Click <i>My Location</i> to center the map<br>
            • Use the polygon or rectangle tool to draw your field<br>
            • Click <i>Save Field</i> to store your AOI and start the analysis
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- libs -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://unpkg.com/leaflet-draw@1.0.4/dist/leaflet.draw.js"></script>
  <script src="https://unpkg.com/@turf/turf@6.5.0/turf.min.js"></script>
  <script>
    // --- CSRF helper ---
    function getCookie(name){
      const v = `; ${document.cookie}`.split(`; ${name}=`); 
      if (v.length === 2) return v.pop().split(';').shift();
    }
    const csrftoken = getCookie('csrftoken');

    // --- Map & layers ---
    const map = L.map('map').setView([11.45, 105.42], 15);
    const esri = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', { attribution: '© Esri' }).addTo(map);
    const osm  = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: '© OSM' });

    const drawnItems = new L.FeatureGroup().addTo(map);
    map.addControl(new L.Control.Draw({
      draw: {
        polygon:{ showArea:true, allowIntersection:false, shapeOptions:{ color:'#10b981', weight:2 } },
        rectangle:{ shapeOptions:{ color:'#22c55e', weight:2 } },
        polyline:false, circle:false, circlemarker:false, marker:false
      },
      edit:{ featureGroup: drawnItems, remove:true }
    }));

    // Toggle base layers (button opens built-in control)
    const layerControl = L.control.layers({ "Esri World Imagery": esri, "OpenStreetMap": osm }, {}, { collapsed: true });
    layerControl.addTo(map);
    document.getElementById('layersBtn').onclick = () => {
      // Simulate a click: Leaflet keeps it open; this focuses the control
      const panes = document.getElementsByClassName('leaflet-control-layers');
      if (panes[0]) panes[0].classList.remove('leaflet-control-layers-collapsed');
    };

    // UI refs
    const areaVal   = document.getElementById('areaVal');
    const areaInput = document.getElementById('areaInput');
    const saveBtn   = document.getElementById('saveBtn');
    const saveMsg   = document.getElementById('saveMsg');
    const viewBtn   = document.getElementById('openOverlayBtn');

    // State
    let LAST = null;            // last drawn GeoJSON Feature
    let LAST_FIELD_ID = null;   // server field id
    let LAST_JOB_ID = null;     // server job id

    // Helpers
    function hectaresFromGeoJSON(gj){
      if(!gj) return 0;
      try{
        if(['Polygon','MultiPolygon'].includes(gj.geometry?.type)) {
          return turf.area(gj)/10000.0;
        }
      }catch(_){}
      return 0;
    }
    function updateAreaDisplay(gj){
      const ha = hectaresFromGeoJSON(gj);
      const txt = `${ha.toFixed(2)} hectares`;
      areaVal.textContent = txt;
      areaInput.value = txt;
    }
    function enableViewBtn(fieldId){
      LAST_FIELD_ID = fieldId;
      viewBtn.removeAttribute('disabled');
      viewBtn.href = `/fields/${fieldId}/risk/`;
    }

    // Draw events
    map.on(L.Draw.Event.CREATED, (e)=>{
      drawnItems.clearLayers();
      drawnItems.addLayer(e.layer);
      LAST = e.layer.toGeoJSON();
      updateAreaDisplay(LAST);
    });
    map.on(L.Draw.Event.EDITED, (e)=>{
      const layers = e.layers.getLayers();
      if(layers.length){ LAST = layers[0].toGeoJSON(); updateAreaDisplay(LAST); }
    });
    map.on(L.Draw.Event.DELETED, ()=>{
      LAST = null; updateAreaDisplay(null);
      viewBtn.setAttribute('disabled','');
      viewBtn.href = '#';
      saveMsg.textContent = '';
    });

    // Geolocate
    document.getElementById('locBtn').onclick = ()=>{
      if(!navigator.geolocation) return;
      navigator.geolocation.getCurrentPosition(pos=>{
        map.setView([pos.coords.latitude, pos.coords.longitude], 16);
      });
    };

    async function postJSON(url, body){
      const res = await fetch(url, {
        method: "POST",
        headers: { "Content-Type": "application/json", "X-CSRFToken": csrftoken },
        body: JSON.stringify(body)
      });
      if(!res.ok) throw new Error(await res.text());
      return res.json();
    }

    // Save AOI → /aoi_upload + /api/fields/
    saveBtn.onclick = async ()=>{
      if(!LAST){ saveMsg.textContent = "⚠️ Draw a polygon or rectangle first."; return; }
      saveBtn.disabled = true; saveMsg.textContent = "Saving...";
      try{
        // 1) server-side AOI store + area check
        const aux = await postJSON("{% url 'aoi_upload' %}", { feature: LAST });

        // 2) create Field via DRF (your FieldViewSet)
        const payload = { 
          name: `Field ${new Date().toISOString().slice(0,19).replace('T',' ')}`, 
          geom: LAST.geometry
        };
        const api = await postJSON("/api/fields/", payload);

        // tolerate multiple shapes of response
        const fieldId = api.field_id ?? api.id ?? api?.field?.id;
        await fetch(`/api/fields/${fieldId}/analyze/`, { method: "POST", headers: { "X-CSRFToken": csrftoken }});
        const jobId   = api.job_id   ?? api.job?.id   ?? null;
        if(!fieldId) throw new Error("No field_id returned from /api/fields/");

        enableViewBtn(fieldId);
        LAST_JOB_ID = jobId;

        const sHa = (aux.area_ha ?? hectaresFromGeoJSON(LAST)).toFixed(2);
        saveMsg.textContent = `✅ Saved. Server area: ${sHa} ha — Analysis started${jobId?` (job ${jobId})`:''}`;
      }catch(e){
        saveMsg.textContent = "❌ Save failed: " + e.message;
      }finally{
        saveBtn.disabled = false;
      }
    };

    // Gate the “View Risk Map” until job is done
    viewBtn.addEventListener('click', async (e)=>{
      if(!LAST_FIELD_ID) {
        e.preventDefault();
        saveMsg.textContent = "ℹ️ Save first to start analysis.";
        return;
      }
      try{
        const r = await fetch(`/api/fields/${LAST_FIELD_ID}/latest_job/?_=${Date.now()}`, {cache:'no-store'});
        if(!r.ok) return; 
        const j = await r.json();
        if (j.status === "done" || j.status === "ready") {
          return; // let the link navigate
        }
        e.preventDefault();
        saveMsg.textContent = "⏳ Analysis running… try again in a moment.";
      }catch(_){
        // Allow navigation; the risk page can handle missing overlay gracefully
      }
    });
  </script>
</body>
</html>