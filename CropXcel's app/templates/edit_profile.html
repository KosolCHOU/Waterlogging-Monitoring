{% extends "base.html" %}
{% block title %}Edit Profile ‚Äì CropXcel{% endblock %}

{% block head %}
<style>
  :root{
    --bg:#eef7f2; --card:#ffffff; --ink:#111827; --muted:#6b7280;
    --line:rgba(17,24,39,.08); --ring:#10b981; --ring-2:#6ee7b7;
  }
  html, body { background:var(--bg); }
  .profile-wrap{ position:fixed; inset:0; display:flex; justify-content:center; align-items:center; overflow:hidden; background:var(--bg); }
  .card{ width:min(720px, 92vw); background:var(--card); border-radius:16px; box-shadow:0 10px 30px rgba(0,0,0,.08); border:1px solid rgba(17,24,39,.06); }
  .pad{ padding:20px; }
  .title{ font-weight:800; margin:0 0 12px; display:flex; gap:8px; align-items:center; }
  .muted{ color:var(--muted) }

  .form-grid {
    display: grid;
    grid-template-columns: 1fr;
    gap: 14px;
    max-width: 640px;   /* ensures uniform cap */
    margin: 0 auto;
  }

  @media (min-width:720px) {
    .form-grid { grid-template-columns: 1fr 1fr; }
    .span-2 { grid-column: 1 / -1; }
  }

  .field {
    display: flex;
    flex-direction: column;
    gap: 6px;
    width: 100%;           /* üîë make field span full grid cell */
    box-sizing: border-box;
  }

  .input,
  .select {
    width: 100%;           /* üîë already here, keep it */
    max-width: 100%;       /* üîë prevents overflow */
    box-sizing: border-box;
    padding: 12px 14px;
    border-radius: 12px;
    border: 1px solid rgba(17,24,39,.12);
    background: #fff;
    color: var(--ink);
    font-size: 14px;
    outline: none;
  }
  .input:focus, .select:focus{ border-color:#10b981; box-shadow:0 0 0 4px rgba(16,185,129,.12); }

  .row-inline{ display:flex; align-items:center; gap:10px; }
  .age-chip{ background:#ecfdf5; color:#065f46; border:1px solid #a7f3d0; padding:8px 12px; border-radius:999px; font-size:13px; font-weight:700; white-space:nowrap; }

  .actions{ display:flex; gap:12px; margin-top:8px; }
  .btn{ display:inline-flex; align-items:center; justify-content:center; gap:8px; border:1px solid rgba(17,24,39,.12); padding:12px 16px; border-radius:12px; background:#fff; color:var(--ink); font-weight:700; cursor:pointer; text-decoration:none; width:100%; }
  .btn:hover{ background:#f9fafb; }
  .btn-primary{ background:linear-gradient(180deg,#16c982,#10b981); color:#0b1220; border:none; box-shadow:0 10px 24px rgba(16,185,129,.22); }

  .errors{ background:#fef2f2; border:1px solid #fecaca; color:#7f1d1d; padding:12px; border-radius:12px; margin-bottom:6px; }
  .field .errorlist{ margin:0; padding:0; list-style:none; }
  .field .errorlist li{ margin-top:4px; font-size:12px; color:#b91c1c; background:#fff1f2; border:1px dashed #fecdd3; padding:6px 8px; border-radius:8px; }
  /* Hints: make smaller, lighter */
  .hint {
    font-size: 11.5px;     /* smaller */
    color: #9ca3af;        /* lighter gray */
    line-height: 1.4;
  }

</style>
{% endblock %}

{% block content %}
<div class="profile-wrap">
  <div class="card pad">
    <h2 class="title">‚úèÔ∏è Edit My Info</h2>
    <p class="muted" style="margin-top:-6px;margin-bottom:8px">Keep this up to date so CropXcel can tailor water-risk tips for your fields.</p>

    {% if form.non_field_errors %}
      <div class="errors">
        {% for e in form.non_field_errors %}<div>{{ e }}</div>{% endfor %}
      </div>
    {% endif %}

    <form method="post" novalidate>
      {% csrf_token %}

      <div class="form-grid">

        {# üîÅ CHANGED: Full name (left) + Phone (right) #}
        <div class="field">
          <label class="label" for="{{ form.full_name.id_for_label }}">Full name</label>
          {{ form.full_name }}
          {% if form.full_name.errors %}{{ form.full_name.errors }}{% else %}
            <div class="hint">Use your real name so support can address you properly.</div>
          {% endif %}
        </div>

        <div class="field">
          <label class="label">
            Phone
          </label>

          {# accept either form.phone or form.contact_phone, depending on your form name #}
          {% if form.phone %}
            {{ form.phone }}
            {% if form.phone.errors %}{{ form.phone.errors }}{% endif %}
          {% elif form.contact_phone %}
            {{ form.contact_phone }}
            {% if form.contact_phone.errors %}{{ form.contact_phone.errors }}{% endif %}
          {% else %}
            {# Fallback input if the form field name differs; posts as 'phone' #}
            <input type="tel" name="phone" id="id_phone" class="input" placeholder="e.g., 012 345 678" pattern="^[0-9+\s()-]{6,20}$">
          {% endif %}

          <div class="hint">We‚Äôll use this to contact you about field support.</div>
        </div>

        <!-- Date of birth -->
        <div class="field">
          <label class="label" for="{{ form.date_of_birth.id_for_label }}">Date of birth</label>
          {{ form.date_of_birth }}
          {% if form.date_of_birth.errors %}{{ form.date_of_birth.errors }}{% else %}
            <div class="hint">We never show this publicly.</div>
          {% endif %}
        </div>

        <!-- Age (computed) -->
        <div class="field">
          <label class="label">Age</label>
          <div class="row-inline">
            <div id="ageChip" class="age-chip">‚Äî years</div>
            <div class="hint">Calculated from your birth date.</div>
          </div>
        </div>

        <!-- Main crop -->
        <div class="field">
          <label class="label" for="id_main_crop">Main crop</label>
          {% if crop_choices %}
            <select name="main_crop" id="id_main_crop" class="select">
              {% for val,label in crop_choices %}
                {% with current=form.data.main_crop|default:form.initial.main_crop|default:profile_obj.main_crop %}
                  <option value="{{ val }}" {% if current == val %}selected{% endif %}>{{ label }}</option>
                {% endwith %}
              {% endfor %}
            </select>
          {% else %}
            {{ form.main_crop }}
          {% endif %}
          {% if form.main_crop.errors %}{{ form.main_crop.errors }}{% endif %}
          <div class="hint">Pick your main rice variety.</div>
        </div>

        <!-- Province -->
        <div class="field">
          <label class="label" for="id_province">Province</label>
          {% if province_choices %}
            <select name="province" id="id_province" class="select">
              {% for val,label in province_choices %}
                {% with current=form.data.province|default:form.initial.province|default:profile_obj.province %}
                  <option value="{{ val }}" {% if current == val %}selected{% endif %}>{{ label }}</option>
                {% endwith %}
              {% endfor %}
            </select>
          {% else %}
            {{ form.province }}
          {% endif %}
          {% if form.province.errors %}{{ form.province.errors }}{% endif %}
          <div class="hint">We use this for local weather and advice.</div>
        </div>

      </div>

      <div class="actions">
        <button class="btn btn-primary" type="submit">üíæ Save changes</button>
        <a class="btn" href="{% url 'profile' %}">‚Ü©Ô∏è Back to profile</a>
      </div>
    </form>

    <script>
      // Ensure widgets have the right classes (in case your form didn't set them)
      (function ensureClasses(){
        const map = {
          'id_full_name': 'input',
          'id_date_of_birth': 'input',
          'id_main_crop': 'select',
          'id_province': 'select',
          'id_phone': 'input',
          'id_contact_phone': 'input',
        };
        Object.entries(map).forEach(([id, cls])=>{
          const el = document.getElementById(id);
          if(el && !el.className.includes(cls)) el.className = (el.className + ' ' + cls).trim();
        });
      })();

      // Live age calculator (unchanged)
      function calcAge(iso){
        if(!iso) return null;
        const dob = new Date(iso);
        if(isNaN(dob)) return null;
        const t = new Date();
        let a = t.getFullYear() - dob.getFullYear();
        const m = t.getMonth() - dob.getMonth();
        if (m < 0 || (m === 0 && t.getDate() < dob.getDate())) a--;
        return a >= 0 ? a : null;
      }
      function updateAge(){
        const i = document.getElementById('id_date_of_birth') || document.querySelector('[name="date_of_birth"]');
        const chip = document.getElementById('ageChip');
        if(!i || !chip) return;
        const a = calcAge(i.value);
        chip.textContent = (a===null) ? '‚Äî years' : (a + ' years');
      }
      document.addEventListener('input', (e)=>{
        if(e.target && (e.target.id==='id_date_of_birth' || e.target.name==='date_of_birth')) updateAge();
      });
      document.addEventListener('DOMContentLoaded', updateAge);
    </script>
  </div>
</div>
{% endblock %}
